<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OQLIV — Multi-TF Candles</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --card:#0c121b;
      --border:#1b2a3a;
      --text:#e8f0f8;
      --muted:#8ea2b6;
      --accent:#00d2be;
    }
    body{
      background: radial-gradient(1200px 700px at 15% 10%, rgba(0,210,190,.08), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(58,160,255,.06), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .panel{
      background: linear-gradient(180deg, rgba(0,210,190,.06), transparent 35%), var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .card-dark{
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 45%), var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .muted{ color: var(--muted); }
    .brand{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color: rgba(232,240,248,.7);
      font-size: .85rem;
    }
    .chartWrap{
      position: relative;
      height: 360px;
      width: 100%;
    }
    .watermark{
      position:absolute;
      right:10px;
      bottom:8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      color: rgba(232,240,248,.55);
      pointer-events:none;
      user-select:none;
    }
    .metaLine{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      color: rgba(232,240,248,.65);
    }
    .btn-primary{
      background: rgba(0,210,190,.18);
      border-color: rgba(0,210,190,.35);
      color: var(--text);
    }
    .btn-primary:hover{
      background: rgba(0,210,190,.28);
      border-color: rgba(0,210,190,.55);
    }
    input.form-control{
      background: rgba(12,18,27,.9);
      border: 1px solid rgba(27,42,58,.9);
      color: var(--text);
    }
    .linkBox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      color: rgba(232,240,248,.7);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 520px;
    }
    .linkBox a{ color: rgba(0,210,190,.9); text-decoration: none; }
    .linkBox a:hover{ text-decoration: underline; }
  </style>
</head>

<body class="text-light" data-bs-theme="dark">
  <div class="container my-4">
    <div class="panel p-3 p-lg-4">

      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-2">
        <div>
          <div class="brand">www.oqliv.com</div>
          <h4 class="mb-0">Technical Analysis</h4>
        </div>

        <div class="d-flex gap-2 align-items-center">
          <input id="tickerInput" class="form-control form-control-sm text-uppercase" style="width:120px" value="SPY" />
          <button id="loadBtn" class="btn btn-sm btn-primary">Load</button>
        </div>
      </div>

      <!-- Shareable link (ticker in querystring) -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div id="status" class="muted small"></div>
        <div class="linkBox">
          Link:
          <a id="shareLink" href="#" target="_blank" rel="noopener">—</a>
        </div>
      </div>

      <div class="row g-3">

        <!-- DAILY (TOP) — pivots-now -->
        <div class="col-12">
          <div class="card-dark p-3">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div><b>Daily</b> <span class="muted">(tf=d) — pivots-now</span></div>
              <div class="metaLine" id="metaD">—</div>
            </div>
            <div class="chartWrap">
              <div id="chartD"></div>
              <div class="watermark">www.oqliv.com</div>
            </div>
          </div>
        </div>

        <!-- WEEKLY — pattern-scan -->
        <div class="col-12">
          <div class="card-dark p-3">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div><b>Weekly</b> <span class="muted">(tf=w)</span></div>
              <div class="metaLine" id="metaW">—</div>
            </div>
            <div class="chartWrap">
              <div id="chartW"></div>
              <div class="watermark">www.oqliv.com</div>
            </div>
          </div>
        </div>

        <!-- MONTHLY — pattern-scan -->
        <div class="col-12">
          <div class="card-dark p-3">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div><b>Monthly</b> <span class="muted">(tf=m)</span></div>
              <div class="metaLine" id="metaM">—</div>
            </div>
            <div class="chartWrap">
              <div id="chartM"></div>
              <div class="watermark">www.oqliv.com</div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    // If hosted on same domain, can be "".
    const API_BASE = "https://oqliv.com";
    const $ = (id) => document.getElementById(id);

    function setStatus(msg){ $("status").textContent = msg || ""; }

    // ---- URL querystring helpers (so OpenClaw can link: /yourpage?ticker=NVDA)
    function getQueryTicker() {
      const sp = new URLSearchParams(window.location.search);
      const t = (sp.get("ticker") || "").trim().toUpperCase();
      return t || null;
    }

    function setQueryTicker(ticker) {
      const url = new URL(window.location.href);
      url.searchParams.set("ticker", (ticker || "").trim().toUpperCase());
      // keep user on the same page, but update the address bar
      window.history.replaceState({}, "", url.toString());
      updateShareLink(ticker);
    }

    function updateShareLink(ticker){
      const url = new URL(window.location.href);
      url.searchParams.set("ticker", (ticker || "").trim().toUpperCase());
      const a = $("shareLink");
      a.href = url.toString();
      a.textContent = url.toString();
    }

    function buildUrl(ticker, tf){
      const t = encodeURIComponent((ticker || "").trim().toUpperCase());
      const f = encodeURIComponent(tf);

      if (tf === "d") {
        const left = 5;
        const eps = 0;
        return `${API_BASE}/performance/api/json/pivots-now?ticker=${t}&tf=${f}&left=${left}&eps=${eps}`;
      }
      return `${API_BASE}/performance/api/json/pattern-scan?ticker=${t}&tf=${f}`;
    }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch {
        throw new Error(`Bad JSON from endpoint. First 200 chars: ${text.slice(0,200)}`);
      }
      if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      return data;
    }

    function toUTCTimestamp(dateLike){
      const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
      const t = Math.floor(d.getTime() / 1000);
      return Number.isFinite(t) ? t : NaN;
    }

    function num(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : NaN;
    }

    // ---- candles (null-safe)
    function parseCandles(payload){
      const arr = payload?.candles || payload?.ohlc || payload?.bars || [];
      return (arr || [])
        .filter(x => x && (x.t || x.time))
        .map(x => {
          const t = x.t || x.time;
          const time = toUTCTimestamp(t);
          if (!Number.isFinite(time)) return null;

          const open  = num(x.o ?? x.open ?? x.Open);
          const high  = num(x.h ?? x.high ?? x.High);
          const low   = num(x.l ?? x.low  ?? x.Low);
          const close = num(x.c ?? x.close?? x.Close);

          if (![open,high,low,close].every(Number.isFinite)) return null;

          const vRaw = (x.v ?? x.volume ?? x.Volume ?? null);
          const volume = (vRaw != null) ? num(vRaw) : null;

          return { time, open, high, low, close, volume: Number.isFinite(volume) ? volume : null };
        })
        .filter(Boolean);
    }

    // ---- pivots-now -> candlestick markers (NO value needed)
    function parsePivotMarkersForCandleSeries(payload, candlesParsed){
      const peaks = payload?.signals?.peak_now || [];
      const valleys = payload?.signals?.valley_now || [];

      const idxToTime = (i) => (candlesParsed[i] ? candlesParsed[i].time : null);

      const markers = [];

      for (const p of peaks) {
        const time = idxToTime(p.i);
        if (!Number.isFinite(time)) continue;
        markers.push({
          time,
          position: "aboveBar",
          shape: "arrowDown",
          color: "rgba(255,77,79,.95)",
          text: "Peak"
        });
      }

      for (const v of valleys) {
        const time = idxToTime(v.i);
        if (!Number.isFinite(time)) continue;
        markers.push({
          time,
          position: "belowBar",
          shape: "arrowUp",
          color: "rgba(45,224,122,.95)",
          text: "Valley"
        });
      }

      markers.sort((a,b) => a.time - b.time);
      return markers;
    }

    function setMeta(metaId, payload, candlesLen){
      const asof = payload?.asof || payload?.asof_utc || "—";
      const last = payload?.last_price ?? payload?.last?.c ?? null;
      const bars = payload?.bars ?? candlesLen ?? "—";
      $(metaId).textContent =
        `asof: ${asof}  |  bars: ${bars}  |  last: ${Number.isFinite(Number(last)) ? Number(last).toFixed(2) : "—"}`;
    }

    // ---- chart instances
    const charts = { m:null, w:null, d:null };

    function destroyChart(tf){
      const c = charts[tf];
      if (c && c._destroy) c._destroy();
      charts[tf] = null;
    }

    // Volume is OFF here (no histogram series). Markers still work.
    function createCandleChart(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 360,
        layout: {
          background: { type: "solid", color: "rgba(12,18,27,.95)" },
          textColor: "rgba(232,240,248,.85)"
        },
        grid: {
          vertLines: { color: "rgba(27,42,58,.6)" },
          horzLines: { color: "rgba(27,42,58,.6)" }
        },
        rightPriceScale: { borderColor: "rgba(27,42,58,.9)" },
        timeScale: { borderColor: "rgba(27,42,58,.9)", timeVisible: true },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
      });

      const candleSeries = chart.addCandlestickSeries({
        upColor: "rgba(45,224,122,.95)",
        downColor: "rgba(255,77,79,.95)",
        borderUpColor: "rgba(45,224,122,.95)",
        borderDownColor: "rgba(255,77,79,.95)",
        wickUpColor: "rgba(45,224,122,.95)",
        wickDownColor: "rgba(255,77,79,.95)"
      });

      function setData(candles, markers) {
        candleSeries.setData(candles);
        candleSeries.setMarkers(Array.isArray(markers) ? markers : []);
        chart.timeScale().fitContent();
      }

      function resize() {
        chart.applyOptions({ width: container.clientWidth, watermark: { visible: false } });
      }

      const onResize = () => resize();
      window.addEventListener("resize", onResize);

      chart._destroy = () => {
        window.removeEventListener("resize", onResize);
        chart.remove();
      };

      return { chart, setData, _destroy: chart._destroy };
    }

    async function loadTF(ticker, tf, containerId, metaId){
      const url = buildUrl(ticker, tf);
      const payload = await fetchJSON(url);

      const candlesParsed = parseCandles(payload);

      let markers = [];
      if (tf === "d") {
        markers = parsePivotMarkersForCandleSeries(payload, candlesParsed);
      }

      setMeta(metaId, payload, candlesParsed.length);

      destroyChart(tf);
      const inst = createCandleChart(containerId);
      inst.setData(
        candlesParsed.map(c => ({ time: c.time, open: c.open, high: c.high, low: c.low, close: c.close })),
        markers
      );
      charts[tf] = inst;
    }

    async function loadAll(tickerOverride){
      const ticker = (tickerOverride || $("tickerInput").value || "").trim().toUpperCase() || "SPY";
      $("tickerInput").value = ticker;

      // Update querystring + shareable link
      setQueryTicker(ticker);

      setStatus(`Loading ${ticker} (d/w/m) ...`);

      try{
        await Promise.all([
          loadTF(ticker, "d", "chartD", "metaD"),
          loadTF(ticker, "w", "chartW", "metaW"),
          loadTF(ticker, "m", "chartM", "metaM"),
        ]);

        setStatus(`Loaded ${ticker}.`);
      } catch(e){
        console.error(e);
        setStatus(`Error: ${e.message}`);
      }
    }

    $("loadBtn").addEventListener("click", () => loadAll());
    $("tickerInput").addEventListener("keydown", (e) => { if (e.key === "Enter") loadAll(); });

    // Auto-load:
    // 1) if URL has ?ticker=NVDA use it
    // 2) else use input default
    const qt = getQueryTicker();
    if (qt) {
      $("tickerInput").value = qt;
      updateShareLink(qt);
      loadAll(qt);
    } else {
      updateShareLink($("tickerInput").value.trim().toUpperCase() || "SPY");
      loadAll();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>