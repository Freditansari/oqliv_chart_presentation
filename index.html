<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OQLIV — Multi-TF Candles</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Lightweight Charts (TradingView) -->
  <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --card:#0c121b;
      --border:#1b2a3a;
      --text:#e8f0f8;
      --muted:#8ea2b6;
      --accent:#00d2be;
    }
    body{
      background: radial-gradient(1200px 700px at 15% 10%, rgba(0,210,190,.08), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(58,160,255,.06), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .panel{
      background: linear-gradient(180deg, rgba(0,210,190,.06), transparent 35%), var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .card-dark{
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 45%), var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    .muted{ color: var(--muted); }
    .brand{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      color: rgba(232,240,248,.7);
      font-size: .85rem;
    }
    .chartWrap{
      position: relative;
      height: 360px;
      width: 100%;
    }
    .watermark{
      position:absolute;
      right:10px;
      bottom:8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      color: rgba(232,240,248,.55);
      pointer-events:none;
      user-select:none;
    }
    .metaLine{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      color: rgba(232,240,248,.65);
    }
    .btn-primary{
      background: rgba(0,210,190,.18);
      border-color: rgba(0,210,190,.35);
      color: var(--text);
    }
    .btn-primary:hover{
      background: rgba(0,210,190,.28);
      border-color: rgba(0,210,190,.55);
    }
    input.form-control{
      background: rgba(12,18,27,.9);
      border: 1px solid rgba(27,42,58,.9);
      color: var(--text);
    }
  </style>
</head>

<body class="text-light" data-bs-theme="dark">
  <div class="container my-4">
    <div class="panel p-3 p-lg-4">

      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <div>
          <div class="brand">www.oqliv.com</div>
          <h4 class="mb-0">Candles + Volume (M / W / D)</h4>
          
        </div>

        <div class="d-flex gap-2 align-items-center">
          <input id="tickerInput" class="form-control form-control-sm text-uppercase" style="width:120px" value="SPY" />
          <button id="loadBtn" class="btn btn-sm btn-primary">Load</button>
        </div>
      </div>

      <div id="status" class="muted small mb-3"></div>

      <div class="row g-3">
        <div class="col-12">
          <div class="card-dark p-3">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div><b>Monthly</b> <span class="muted">(tf=m)</span></div>
              <div class="metaLine" id="metaM">—</div>
            </div>
            <div class="chartWrap">
              <div id="chartM"></div>
              <div class="watermark">www.oqliv.com</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card-dark p-3">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div><b>Weekly</b> <span class="muted">(tf=w)</span></div>
              <div class="metaLine" id="metaW">—</div>
            </div>
            <div class="chartWrap">
              <div id="chartW"></div>
              <div class="watermark">www.oqliv.com</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card-dark p-3">
            <div class="d-flex justify-content-between align-items-baseline mb-2">
              <div><b>Daily</b> <span class="muted">(tf=d)</span></div>
              <div class="metaLine" id="metaD">—</div>
            </div>
            <div class="chartWrap">
              <div id="chartD"></div>
              <div class="watermark">www.oqliv.com</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // If your HTML is hosted on the SAME domain (oqliv.com) keep API_BASE = ""
    // If testing locally, set API_BASE = "https://oqliv.com"
    const API_BASE = "https://oqliv.com";

    const $ = (id) => document.getElementById(id);

    function setStatus(msg) { $("status").textContent = msg || ""; }

    function buildUrl(ticker, tf) {
      const t = encodeURIComponent((ticker || "").trim().toUpperCase());
      const f = encodeURIComponent(tf);
      return `${API_BASE}/performance/api/json/pattern-scan?ticker=${t}&tf=${f}`;
    }

    async function fetchJSON(url) {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch (e) {
        throw new Error(`Bad JSON from endpoint. First 200 chars: ${text.slice(0,200)}`);
      }
      if (!res.ok) {
        throw new Error(data?.error || `HTTP ${res.status}`);
      }
      return data;
    }

    // ---- Parsing: candles and volume (no python changes required)
    function parseCandles(payload) {
      const arr = payload?.candles || payload?.ohlc || payload?.bars || [];
      // expected: [{t,o,h,l,c, v?}]
      return (arr || [])
        .filter(x => x && (x.t || x.time))
        .map(x => {
          const t = x.t || x.time;
          const time = toUTCTimestamp(t);
          return {
            time,
            open: num(x.o ?? x.open),
            high: num(x.h ?? x.high),
            low:  num(x.l ?? x.low),
            close:num(x.c ?? x.close),
            volume: (x.v ?? x.volume ?? null) != null ? num(x.v ?? x.volume) : null
          };
        })
        .filter(x => isFinite(x.open) && isFinite(x.high) && isFinite(x.low) && isFinite(x.close));
    }

    function parseVolumes(payload, candlesParsed) {
      // Priority:
      // 1) candle.volume if present
      // 2) payload.volumes / payload.volume / payload.bars_volume arrays (if any)
      const fromCandles = candlesParsed
        .filter(c => c.volume != null && isFinite(c.volume))
        .map(c => ({ time: c.time, value: c.volume }));

      if (fromCandles.length) return fromCandles;

      const alt = payload?.volumes || payload?.volume || payload?.bars_volume || null;
      if (Array.isArray(alt) && alt.length) {
        // Try to map by index to candle timestamps
        const out = [];
        for (let i = 0; i < Math.min(alt.length, candlesParsed.length); i++) {
          const v = num(alt[i]);
          if (isFinite(v)) out.push({ time: candlesParsed[i].time, value: v });
        }
        if (out.length) return out;
      }

      return []; // no volume available
    }

    function toUTCTimestamp(dateLike) {
      // Accept "YYYY-MM-DD", ISO strings, or Date.
      // Lightweight charts wants "UTCTimestamp" (seconds).
      const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
      return Math.floor(d.getTime() / 1000);
    }

    function num(x) {
      const n = Number(x);
      return isFinite(n) ? n : NaN;
    }

    function setMeta(metaId, payload, candlesLen) {
      const asof = payload?.asof || payload?.asof_utc || "—";
      const last = payload?.last_price;
      const bars = payload?.bars ?? candlesLen ?? "—";
      $(metaId).textContent = `asof: ${asof}  |  bars: ${bars}  |  last: ${isFinite(last) ? last.toFixed(2) : "—"}`;
    }

    // ---- Chart instances
    const charts = {
      m: null,
      w: null,
      d: null
    };

    function destroyChart(tf) {
      const c = charts[tf];
      if (c && c._destroy) c._destroy();
      charts[tf] = null;
    }

    function createCandleVolumeChart(containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 360,
        layout: {
          background: { type: "solid", color: "rgba(12,18,27,.95)" },
          textColor: "rgba(232,240,248,.85)"
        },
        grid: {
          vertLines: { color: "rgba(27,42,58,.6)" },
          horzLines: { color: "rgba(27,42,58,.6)" }
        },
        rightPriceScale: {
          borderColor: "rgba(27,42,58,.9)"
        },
        timeScale: {
          borderColor: "rgba(27,42,58,.9)",
          timeVisible: true
        },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
      });

      const candleSeries = chart.addCandlestickSeries({
        upColor: "rgba(45,224,122,.95)",
        downColor: "rgba(255,77,79,.95)",
        borderUpColor: "rgba(45,224,122,.95)",
        borderDownColor: "rgba(255,77,79,.95)",
        wickUpColor: "rgba(45,224,122,.95)",
        wickDownColor: "rgba(255,77,79,.95)"
      });

      const volSeries = chart.addHistogramSeries({
        priceFormat: { type: "volume" },
        priceScaleId: "",
        scaleMargins: { top: 0.75, bottom: 0 }
      });

      function setData(candles, vols) {
        candleSeries.setData(candles);
        if (vols && vols.length) {
          // Color volume by candle direction
          const volColored = vols.map((v, i) => {
            const c = candles[i];
            const up = c && c.close >= c.open;
            return { time: v.time, value: v.value, color: up ? "rgba(45,224,122,.35)" : "rgba(255,77,79,.35)" };
          });
          volSeries.setData(volColored);
        } else {
          volSeries.setData([]);
        }
        chart.timeScale().fitContent();
      }

      function resize() {
        chart.applyOptions({ width: container.clientWidth,watermark:{visible: false} });
      }

      const onResize = () => resize();
      window.addEventListener("resize", onResize);

      // small helper so we can cleanup properly
      chart._destroy = () => {
        window.removeEventListener("resize", onResize);
        chart.remove();
      };

      return { chart, setData, _destroy: chart._destroy };
    }

    async function loadTF(ticker, tf, containerId, metaId) {
      const url = buildUrl(ticker, tf);
      const payload = await fetchJSON(url);

      const candlesParsed = parseCandles(payload);
      const volsParsed = parseVolumes(payload, candlesParsed);

      setMeta(metaId, payload, candlesParsed.length);

      // Create / reuse chart
      destroyChart(tf);
      const inst = createCandleVolumeChart(containerId);
      inst.setData(
        candlesParsed.map(c => ({ time: c.time, open: c.open, high: c.high, low: c.low, close: c.close })),
        volsParsed
      );
      charts[tf] = inst;

      // If no volume, show subtle note in status (once)
      if (!volsParsed.length) {
        return { tf, volume: false };
      }
      return { tf, volume: true };
    }

    async function loadAll() {
      const ticker = $("tickerInput").value.trim().toUpperCase() || "SPY";
      $("tickerInput").value = ticker;

      setStatus(`Loading ${ticker} (m/w/d) ...`);

      try {
        const results = await Promise.all([
          loadTF(ticker, "m", "chartM", "metaM"),
          loadTF(ticker, "w", "chartW", "metaW"),
          loadTF(ticker, "d", "chartD", "metaD"),
        ]);

        const missingVol = results.filter(r => !r.volume).map(r => r.tf.toUpperCase());
        if (missingVol.length) {
          setStatus(`Loaded ${ticker}. Volume not found in payload for: ${missingVol.join(", ")} (candles still shown).`);
        } else {
          setStatus(`Loaded ${ticker}.`);
        }
      } catch (e) {
        console.error(e);
        setStatus(`Error: ${e.message}`);
      }
    }

    $("loadBtn").addEventListener("click", loadAll);
    $("tickerInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadAll();
    });

    // Auto-load on open
    loadAll();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>